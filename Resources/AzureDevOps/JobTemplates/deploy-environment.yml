parameters:
  AzureSubscription: ''  
  Environment: ''
  PackageFile:  ''
  ArmTemplateFolder: ''
  Location: 'West Europe'
  EnvironmentTag: ''
  ParentBusinessTag: ''
  ServiceOfferingTag: ''
  ResourceGroup: ''
  ArtifactName: 'DFC.ServiceTaxonomy.Editor'
  WebAppName: ''
  OrchardCoreUri: ''
  SqlDatabaseConnStr: ''
  SiteName: 'ServiceTaxonomy'
  EditorAdminUsername: ''
  EditorAdminUserEmail: ''
  EditorAdminUserPassword: ''

jobs:    
- deployment: DeployArmTemplateTo_${{ parameters.Environment }}
  pool: 'NCS - CI and CD'
  displayName: "Deploy arm templates"
  environment: ${{ parameters.Environment }}
  strategy:
    runOnce:
      deploy:
        steps:
        - template: /AzureDevOpsTemplates/Deploy/StepTemplates/dfc-arm-deploy.yml@dfc-devops
          parameters:
            ArmTemplateRoot: '${{ parameters.ArmTemplateFolder }}'
            ResourceGroup: '${{ parameters.ResourceGroup }}'
            AzureSubscription: '${{ parameters.AzureSubscription }}'
            EnvironmentTag: '${{ parameters.EnvironmentTag }}'
            ParentBusinessTag: '${{ parameters.ParentBusinessTag }}'            
            ServiceOfferingTag: '${{ parameters.ServiceOfferingTag }}'

- deployment: DeployEditorTo_${{ parameters.Environment }}
  pool: 'NCS - CI and CD'
  displayName: "Deploy WebApp"
  environment: ${{ parameters.Environment }}
  dependsOn: 
  - DeployArmTemplateTo_${{ parameters.Environment }}
  variables:
    InitialiserWorkingDir: $(System.DefaultWorkingDirectory)\DFC.ServiceTaxonomy.OrchardCoreInitialiser\
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzureRmWebAppDeployment@4
          displayName: 'Azure App Service Deploy: ${{ parameters.WebAppName }}'
          inputs:
            azureSubscription: '${{ parameters.AzureSubscription }}'
            appType: webApp
            WebAppName: '${{ parameters.WebAppName }}'
            Package: "${{ parameters.PackageFile }}"
            ResourceGroupName: '${{ parameters.ResourceGroup }}'
            UseWebDeploy: true
        - task: ExtractFiles@1
          displayName: 'Extract OrchardCoreInitialiser files'
          inputs:
            archiveFilePatterns: '$(Pipeline.Workspace)\DFC.ServiceTaxonomy.OrchardCoreInitialiser.DeploymentPackages\DeploymentPackages\DFC.ServiceTaxonomy.OrchardCoreInitialiser.zip'
            destinationFolder: $(InitialiserWorkingDir)
        - script: DFC.ServiceTaxonomy.OrchardCoreInitialiser.exe --uri=${{ parameters.OrchardCoreUri }} --connectionstring="${{ parameters.SqlDatabaseConnStr }}" --databasetype=SqlConnection --sitename=${{ parameters. SiteName }} --recipename="Service Taxonomy Editor" --username=${{ parameters.EditorAdminUsername }} --email=${{ parameters.EditorAdminUserEmail }} --password=${{ parameters.EditorAdminUserPassword }}
          displayName: 'Execute Orchard Core Initialiser'
          workingDirectory: $(InitialiserWorkingDir)
